<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeCompass - AI Onboarding & Knowledge Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-card: #151515;
            --bg-hover: #202020;
            --border-primary: #333333;
            --border-secondary: #444444;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #666666;
            --accent-primary: #00d4ff;
            --accent-secondary: #0099cc;
            --accent-gradient: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4444;
            /* Simplified glass effect */
            --glass-bg: rgba(21, 21, 21, 0.8); /* Use a solid, slightly transparent background */
            --glass-border: #333333; /* Keep border for definition */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated background - simplified */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 153, 204, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 136, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            /* Reduced animation intensity */
            animation: gradient-shift 20s ease infinite alternate; 
        }

        @keyframes gradient-shift {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(360deg) scale(1.05); } /* Slightly less scale */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .header {
            text-align: center;
            margin-bottom: 60px;
            padding: 60px 0;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: var(--accent-gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 
                0 10px 20px rgba(0, 212, 255, 0.2), /* Reduced shadow */
                0 0 40px rgba(0, 212, 255, 0.05); /* Reduced glow */
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(3deg); } /* Reduced movement */
        }

        .header h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: -0.02em;
            position: relative;
        }

        .header h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--accent-gradient);
            border-radius: 2px;
            animation: pulse-line 2s ease-in-out infinite;
        }

        @keyframes pulse-line {
            0%, 100% { width: 100px; opacity: 1; }
            50% { width: 120px; opacity: 0.8; } /* Reduced pulse intensity */
        }

        .tagline {
            font-size: clamp(1rem, 2vw, 1.3rem);
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
            animation: fade-in-up 1s ease 0.3s both;
        }

        .subtitle {
            font-size: clamp(0.9rem, 1.5vw, 1.1rem);
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
            opacity: 0.8;
            animation: fade-in-up 1s ease 0.6s both;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px); /* Reduced initial translateY */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Glass Cards - Simplified */
        .glass-card {
            background: var(--glass-bg);
            /* backdrop-filter: blur(20px); Removed for performance */
            /* -webkit-backdrop-filter: blur(20px); Removed for performance */
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.1), /* Reduced shadow */
                inset 0 1px 0 rgba(255, 255, 255, 0.05); /* Reduced inset shadow */
            margin-bottom: 30px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Faster transition */
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--accent-gradient);
            opacity: 0.3; /* Reduced opacity */
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.01) 50%, /* Reduced opacity */
                transparent 70%
            );
            pointer-events: none;
            transform: translateX(-100%);
            transition: transform 0.5s ease; /* Faster transition */
        }

        .glass-card:hover {
            transform: translateY(-4px); /* Reduced translateY */
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.2), /* Reduced shadow */
                inset 0 1px 0 rgba(255, 255, 255, 0.1), /* Reduced inset shadow */
                0 0 50px rgba(0, 212, 255, 0.05); /* Reduced glow */
            border-color: rgba(0, 212, 255, 0.2); /* Reduced border color opacity */
        }

        .glass-card:hover::after {
            transform: translateX(100%);
        }

        /* Input Fields */
        .input-section h2 {
            font-size: 1.8rem;
            margin-bottom: 24px;
            color: var(--text-primary);
            font-weight: 600;
            position: relative;
            display: inline-block;
        }

        .input-section h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--accent-gradient);
            border-radius: 2px;
        }

        .input-group {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .input-field {
            flex: 1;
            min-width: 300px;
            padding: 18px 24px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 
                0 0 0 4px rgba(0, 212, 255, 0.05), /* Reduced shadow opacity */
                0 4px 15px rgba(0, 212, 255, 0.1); /* Reduced shadow opacity */
            background: var(--bg-tertiary);
            transform: translateY(-1px); /* Reduced translateY */
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
            transition: opacity 0.3s ease;
        }

        .input-field:focus::placeholder {
            opacity: 0.5;
        }

        /* Buttons */
        .btn {
            padding: 18px 36px;
            background: var(--accent-gradient);
            color: var(--text-primary);
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2); /* Reduced shadow */
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.05), /* Reduced opacity */
                transparent
            );
            transform: translateX(-100%);
            transition: transform 0.5s ease; /* Faster transition */
        }

        .btn:hover {
            transform: translateY(-2px); /* Reduced translateY */
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); /* Reduced shadow */
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Reduced shadow */
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.1); /* Reduced shadow */
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.2); /* Reduced shadow */
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.3); /* Reduced shadow */
        }

        /* Google Sign-in Button */
        .google-signin-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-primary);
            border-radius: 16px;
            padding: 18px 36px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .google-signin-btn img {
            width: 20px;
            height: 20px;
        }

        .google-signin-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .google-signin-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-1px); /* Reduced translateY */
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.1); /* Reduced shadow */
        }

        .google-signin-btn:hover::before {
            left: 0;
        }

        /* User Stats */
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-secondary);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-gradient);
        }

        .stat-item:hover {
            transform: translateY(-2px); /* Reduced translateY */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* Reduced shadow */
            border-color: var(--accent-primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-primary);
            margin-bottom: 8px;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Progress Section */
        .progress-section {
            margin-bottom: 30px;
        }

        .progress-section h3 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid var(--border-primary);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-gradient);
            width: 0%; /* Initial width */
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1), /* Reduced opacity */
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            font-weight: 500;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .status-log {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            border-left: 4px solid var(--accent-primary);
            line-height: 1.5;
        }

        /* Chat Section */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chat-header h3 {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .chat-container {
            height: 600px;
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-secondary);
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05); /* Reduced shadow */
        }

        .chat-messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            padding: 16px 20px;
            border-radius: 18px;
            max-width: 80%;
            font-size: 15px;
            line-height: 1.6;
            animation: message-appear 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes message-appear {
            from {
                opacity: 0;
                transform: translateY(5px); /* Reduced translateY */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--accent-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.15); /* Reduced shadow */
        }

        .message.assistant {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05); /* Reduced shadow */
        }

        .chat-input-container {
            display: flex;
            padding: 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            gap: 16px;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.05); /* Reduced shadow */
            background: var(--bg-card);
        }

        /* Repository Cards */
        .repo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .repo-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .repo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .repo-card:hover {
            transform: translateY(-3px); /* Reduced translateY */
            border-color: var(--accent-primary);
            background: var(--bg-hover);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* Reduced shadow */
        }

        .repo-card:hover::before {
            transform: scaleX(1);
        }

        .repo-name {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--accent-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .repo-name::before {
            content: 'üìÅ';
            font-size: 1.2rem;
        }

        .repo-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Features Section */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 80px;
        }

        .feature-card {
            background: var(--glass-bg);
            /* backdrop-filter: blur(20px); Removed for performance */
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Faster transition */
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center,
                rgba(0, 212, 255, 0.02) 0%, /* Reduced opacity */
                transparent 70%
            );
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-6px); /* Reduced translateY */
            border-color: var(--accent-primary);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); /* Reduced shadow */
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-icon {
            font-size: 3.5rem;
            margin-bottom: 24px;
            display: block;
            filter: drop-shadow(0 2px 4px rgba(0, 212, 255, 0.15)); /* Reduced shadow */
        }

        .feature-title {
            font-size: 1.5rem;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .feature-description {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* Session Items */
        .session-item {
            padding: 18px 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-card);
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            position: relative;
            overflow: hidden;
        }

        .session-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .session-item:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: translateX(4px); /* Reduced translateX */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Reduced shadow */
        }

        .session-item:hover::before {
            transform: scaleY(1);
        }

        /* Alert Messages */
        .error, .success {
            padding: 18px 24px;
            border-radius: 12px;
            margin-top: 16px;
            font-weight: 500;
            border-left: 4px solid;
            animation: fade-in 0.3s ease;
        }

        .error {
            background: rgba(255, 68, 68, 0.05); /* Reduced opacity */
            color: var(--error);
            border-color: var(--error);
            border-left-color: var(--error);
        }

        .success {
            background: rgba(0, 255, 136, 0.05); /* Reduced opacity */
            color: var(--success);
            border-color: rgba(0, 255, 136, 0.15); /* Reduced opacity */
            border-left-color: var(--success);
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(5px); /* Reduced translateY */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-primary);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .glass-card {
                padding: 24px;
                border-radius: 20px;
            }

            .input-group {
                flex-direction: column;
            }

            .input-field {
                min-width: unset;
            }

            .chat-container {
                height: 500px;
            }

            .features {
                grid-template-columns: 1fr;
                margin-top: 60px;
            }

            .user-stats {
                grid-template-columns: 1fr;
            }

            .repo-grid {
                grid-template-columns: 1fr;
            }

            .chat-header {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                text-align: center;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üß≠</div>
            </div>
            <h1>CodeCompass</h1>
            <p class="tagline">AI-Powered Code Onboarding & Knowledge Agent</p>
            <p class="subtitle">// Made by developers, for developers</p>
        </div>
        
        <!-- Landing Section -->
        <div class="glass-card" id="landingSection">
            <div style="text-align: center;">
                <h2 style="font-size: 2.2rem; margin-bottom: 20px; color: var(--text-primary);">Unlock Your Codebase Potential</h2>
                <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 30px;">
                    Seamlessly onboard new team members, understand complex projects, and get instant answers about your code.
                </p>
                <button id="getStartedBtn" class="btn">Get Started</button>
            </div>
        </div>

        <!-- Main App Content (initially hidden) -->
        <div id="appContent" style="display: none;">
            <!-- Login Section -->
            <div class="glass-card">
                <div id="loginSection" style="text-align: center; margin-bottom: 40px;">
                    <h2>Sign In to CodeCompass</h2>
                    <button id="googleSignInBtn" class="google-signin-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                        Sign in with Google
                    </button>
                    
                    <!-- User Info (shown after login) -->
                    <div id="userInfo" class="user-info" style="display: none;">
                        <p style="font-size: 1.1rem; margin-bottom: 16px;">Welcome back, <strong><span id="userName"></span></strong>!</p>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Email: <span id="userEmail"></span></p>
                        
                        <div class="user-stats">
                            <div class="stat-item">
                                <div class="stat-value"><span id="reposProcessed">0</span>/<span id="maxRepos"></span></div>
                                <div class="stat-label">Repos Processed Today</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value"><span id="messagesSent">0</span>/<span id="maxMessages"></span></div>
                                <div class="stat-label">Messages Sent Today</div>
                            </div>
                        </div>
                        
                        <button id="signOutBtn" class="btn btn-danger" style="margin-top: 20px;">Sign Out</button>
                    </div>
                </div>
            </div>

            <!-- Process GitHub Repository Section -->
            <div class="glass-card">
                <div id="mainAppSection" class="input-section" style="display: none;">
                    <h2>Process GitHub Repository</h2>
                    <div class="input-group">
                        <input type="text" id="githubUrl" class="input-field" placeholder="https://github.com/username/repository" />
                        <button id="processBtn" class="btn">Process Repository</button>
                    </div>
                    <div style="display: flex; align-items: center; margin-top: 16px; margin-bottom: 16px;">
                        <label for="privateRepoToggle" style="color: var(--text-secondary); font-size: 15px; margin-right: 12px;">Private Repository?</label>
                        <label class="switch">
                            <input type="checkbox" id="privateRepoToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <input type="password" id="patTokenInput" class="input-field" placeholder="GitHub Personal Access Token (PAT)" style="display: none; margin-bottom: 24px;" />
                    <p style="color: var(--text-tertiary); font-size: 14px; margin-top: 8px;">
                        Please use a classic GitHub Personal Access Token (PAT). Your PAT should look like: <code style="font-family: 'JetBrains Mono', monospace; background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; color: var(--accent-primary);">ghp_xxxxxxxxxxxxxxxxxxxxxx</code>.
                        For private repositories, a PAT with 'repo' scope is required.
                        <br><br>
                        <strong>Important:</strong> Do not close this tab while processing is in progress.
                    </p>
                </div>
            </div>
            
            <!-- New CSS for Toggle Switch -->
            <style>
                .switch {
                    position: relative;
                    display: inline-block;
                    width: 48px;
                    height: 28px;
                }

                .switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                }

                .slider {
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: var(--border-primary);
                    -webkit-transition: .4s;
                    transition: .4s;
                    border-radius: 28px;
                }

                .slider:before {
                    position: absolute;
                    content: "";
                    height: 20px;
                    width: 20px;
                    left: 4px;
                    bottom: 4px;
                    background-color: white;
                    -webkit-transition: .4s;
                    transition: .4s;
                    border-radius: 50%;
                }

                input:checked + .slider {
                    background-color: var(--accent-primary);
                }

                input:focus + .slider {
                    box-shadow: 0 0 1px var(--accent-primary);
                }

                input:checked + .slider:before {
                    -webkit-transform: translateX(20px);
                    -ms-transform: translateX(20px);
                    transform: translateX(20px);
                }
            </style>
            
            <!-- Progress Section -->
            <div id="progressSection" class="glass-card progress-section">
                <h3>Processing Repository...</h3>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">Initializing...</div>
                <div id="statusLog" class="status-log"></div>
            </div>
            
            <!-- Processed Repositories Section -->
            <div id="processedReposSection" class="glass-card" style="display: none;">
                <h2>My Processed Repositories</h2>
                <div id="repoButtonsContainer" class="repo-grid">
                    <p style="text-align: center; color: var(--text-tertiary); width: 100%;">No repositories processed yet.</p>
                </div>
                <button id="refreshReposBtn" class="btn btn-secondary">Refresh Repositories</button>
            </div>

            <!-- Repository Chat Sessions -->
            <div id="repoChatSessionsSection" class="glass-card" style="display: none;">
                <h2>Chat Sessions for <span id="currentRepoName" style="color: var(--accent-primary);"></span></h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                    <h3 style="margin: 0;">Previous Chats</h3>
                    <button id="newChatForRepoBtn" class="btn">+ New Chat for this Repo</button>
                </div>
                <div id="repoChatSessionsList" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border-primary); border-radius: 12px; padding: 16px; background: var(--bg-tertiary);">
                    <p style="text-align: center; color: var(--text-tertiary);">No chat sessions for this repository.</p>
                </div>
                <button id="backToReposBtn" class="btn btn-secondary" style="margin-top: 24px;">‚Üê Back to Repositories</button>
            </div>

            <!-- Chat Section -->
            <div id="chatSection" class="glass-card chat-section">
                <div class="chat-header">
                    <h3>Ask Questions About Your Code</h3>
                    <button id="backToChatSessionsBtn" class="btn btn-secondary">‚Üê Back to Chat Sessions</button>
                </div>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask anything about the repository... (e.g., 'How do I run tests?')" />
                        <button id="sendBtn" class="btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Features Section -->
        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">üîç</div>
                <div class="feature-title">Smart Analysis</div>
                <p class="feature-description">AI analyzes your entire codebase structure, dependencies, and architecture patterns with deep understanding of modern development practices.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üí¨</div>
                <div class="feature-title">Interactive Q&A</div>
                <p class="feature-description">Ask natural language questions about code functionality, setup procedures, and best practices tailored specifically to your project.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üìö</div>
                <div class="feature-title">Auto Documentation</div>
                <p class="feature-description">Generates comprehensive documentation, READMEs, and onboarding guides automatically from your actual codebase structure and patterns.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "your-api-key", // Replace with your actual API Key
            authDomain: "your-auth-domain", // Replace with your actual Auth Domain
            projectId: "your-project-id", // Replace with your actual Project ID
            storageBucket: "your-storage-bucket", // Replace with your actual Storage Bucket
            messagingSenderId: "your-messaging-sender-id", // Replace with your actual Messaging Sender ID
            appId: "your-appID" // Replace with your actual App ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        const API_BASE = 'your-backend-api-url'; // Replace with your actual backend API URL
        let currentRepoId = null;
        let currentUser = null; // To store authenticated user info
        let currentSessionId = null; // To store the current chat session ID
        
        // DOM elements
        const landingSection = document.getElementById('landingSection');
        const getStartedBtn = document.getElementById('getStartedBtn');
        const appContent = document.getElementById('appContent');
        const loginSection = document.getElementById('loginSection');
        const mainAppSection = document.getElementById('mainAppSection');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const userEmailSpan = document.getElementById('userEmail');
        const reposProcessedSpan = document.getElementById('reposProcessed');
        const maxReposSpan = document.getElementById('maxRepos');
        const messagesSentSpan = document.getElementById('messagesSent');
        const maxMessagesSpan = document.getElementById('maxMessages');

        const githubUrlInput = document.getElementById('githubUrl');
        const processBtn = document.getElementById('processBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const statusLog = document.getElementById('statusLog');
        const chatSection = document.getElementById('chatSection');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const processedReposSection = document.getElementById('processedReposSection');
        const repoButtonsContainer = document.getElementById('repoButtonsContainer');
        const refreshReposBtn = document.getElementById('refreshReposBtn');
        const repoChatSessionsSection = document.getElementById('repoChatSessionsSection');
        const currentRepoNameSpan = document.getElementById('currentRepoName');
        const newChatForRepoBtn = document.getElementById('newChatForRepoBtn');
        const repoChatSessionsList = document.getElementById('repoChatSessionsList');
        const backToReposBtn = document.getElementById('backToReposBtn');
        const backToChatSessionsBtn = document.getElementById('backToChatSessionsBtn');
        const privateRepoToggle = document.getElementById('privateRepoToggle');
        const patTokenInput = document.getElementById('patTokenInput');

        // Helper functions (defined first to ensure availability)
        function updateUserInfo(userData) {
            userNameSpan.textContent = userData.name || userData.email;
            userEmailSpan.textContent = userData.email;
            reposProcessedSpan.textContent = userData.limits.repos_processed_today;
            maxReposSpan.textContent = userData.limits.max_repos_per_day;
            messagesSentSpan.textContent = userData.limits.messages_sent_today;
            maxMessagesSpan.textContent = userData.limits.max_messages_per_day;
            userInfoDiv.style.display = 'block';
        }

        function showAppContent() {
            landingSection.style.display = 'none';
            appContent.style.display = 'block';
            loginSection.style.display = 'none'; /* Ensure login section is hidden */
            mainAppSection.style.display = 'block';
            processedReposSection.style.display = 'block';
            repoChatSessionsSection.style.display = 'none';
            chatSection.style.display = 'none';
            progressSection.style.display = 'none'; /* Ensure progress is hidden */
            
            // Reset UI elements
            statusLog.innerHTML = '';
            chatMessages.innerHTML = '';
            githubUrlInput.value = '';
            chatInput.value = '';
            currentSessionId = null;
            currentRepoId = null;
        }

        function showLoginContent() {
            landingSection.style.display = 'none';
            appContent.style.display = 'block';
            loginSection.style.display = 'block';
            mainAppSection.style.display = 'none';
            userInfoDiv.style.display = 'none'; /* Ensure user info is hidden */
            processedReposSection.style.display = 'none';
            repoChatSessionsSection.style.display = 'none';
            chatSection.style.display = 'none';
            progressSection.style.display = 'none'; /* Ensure progress is hidden */
        }

        function showProcessedReposSection() {
            processedReposSection.style.display = 'block';
            repoChatSessionsSection.style.display = 'none';
            chatSection.style.display = 'none';
            progressSection.style.display = 'none';
            currentRepoId = null; // Clear selected repo
            currentSessionId = null; // Clear selected session
            chatMessages.innerHTML = ''; // Clear chat messages
            chatInput.value = ''; // Clear chat input
            fetchProcessedRepos(); // Refresh the list of processed repos
        }
        
        function isValidGitHubUrl(url) {
            const regex = /^https:\/\/github\.com\/[\w\-\.]+\/[\w\-\.]+\/?$/;
            return regex.test(url);
        }

        function updateProgress(percentage, status) {
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${Math.round(percentage)}% - ${status}`;
        }
        
        function addStatusLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            statusLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }
        
        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = content.replace(/\n/g, '<br>');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            // Append to the main-card or a more appropriate error display area
            document.querySelector('#appContent').appendChild(errorDiv); // Append to appContent
        }

        async function verifyTokenAndFetchLimits(idToken) {
            try {
                const response = await fetch(`${API_BASE}/verify-google-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id_token: idToken }),
                });

                const data = await response.json();
                if (response.ok) {
                    console.log("Token verified, user data:", data);
                    updateUserInfo(data);
                } else {
                    console.error("Backend token verification failed:", data.error);
                    alert(`Authentication error: ${data.error}`);
                    auth.signOut(); // Force sign out if backend verification fails
                }
            } catch (error) {
                console.error("Error during token verification:", error);
                alert(`Network error during authentication: ${error.message}`);
                auth.signOut();
            }
        }

        async function fetchProcessedRepos() {
            if (!currentUser) {
                repoButtonsContainer.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); width: 100%;">Please sign in to view processed repositories.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/get-user-processed-repos?uid=${currentUser.uid}`);
                const data = await response.json();

                if (response.ok) {
                    displayProcessedRepos(data.repos);
                } else {
                    console.error("Error fetching processed repos:", data.error);
                    repoButtonsContainer.innerHTML = `<p style="text-align: center; color: var(--error); width: 100%;">Error loading repositories: ${data.error}</p>`;
                }
            } catch (error) {
                console.error("Network error fetching processed repos:", error);
                repoButtonsContainer.innerHTML = `<p style="text-align: center; color: var(--error); width: 100%;">Network error loading repositories.</p>`;
            }
        }

        function displayProcessedRepos(repos) {
            repoButtonsContainer.innerHTML = ''; // Clear existing buttons
            if (repos.length === 0) {
                repoButtonsContainer.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); width: 100%;">No repositories processed yet.</p>';
                return;
            }

            repos.forEach(repo => {
                const repoCard = document.createElement('div');
                repoCard.className = 'repo-card';
                repoCard.onclick = () => loadRepoChats(repo.repo_id, repo.owner, repo.repo);
                repoCard.innerHTML = `
                    <div class="repo-name">${repo.owner}/${repo.repo}</div>
                    <div class="repo-description">${repo.description || 'No description available.'}</div>
                `;
                repoButtonsContainer.appendChild(repoCard);
            });
        }

        async function loadRepoChats(repoId, owner, repoName) {
            if (!currentUser) {
                alert("Please sign in to view chat sessions.");
                return;
            }
            currentRepoId = repoId;
            currentRepoNameSpan.textContent = `${owner}/${repoName}`;
            processedReposSection.style.display = 'none';
            repoChatSessionsSection.style.display = 'block';
            chatSection.style.display = 'none'; // Hide chat section until a session is loaded/started
            progressSection.style.display = 'none';

            await fetchRepoChatSessions(repoId);
        }

        async function fetchRepoChatSessions(repoId) {
            if (!currentUser || !repoId) {
                repoChatSessionsList.innerHTML = '<p style="text-align: center; color: var(--text-tertiary);">Select a repository to view its chat sessions.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/get-user-chat-sessions?uid=${currentUser.uid}&repo_id=${repoId}`);
                const data = await response.json();

                if (response.ok) {
                    displayRepoChatSessions(data.sessions);
                } else {
                    console.error("Error fetching repo chat sessions:", data.error);
                    repoChatSessionsList.innerHTML = `<p style="text-align: center; color: var(--error);">Error loading sessions: ${data.error}</p>`;
                }
            } catch (error) {
                console.error("Network error fetching repo chat sessions:", error);
                repoChatSessionsList.innerHTML = `<p style="text-align: center; color: var(--error);">Network error loading sessions.</p>`;
            }
        }

        function displayRepoChatSessions(sessions) {
            repoChatSessionsList.innerHTML = ''; // Clear existing list
            if (sessions.length === 0) {
                repoChatSessionsList.innerHTML = '<p style="text-align: center; color: var(--text-tertiary);">No chat sessions for this repository.</p>';
                return;
            }

            sessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                sessionItem.onclick = () => loadChatHistory(session.session_id, session.repo_id);

                const firstQuestion = session.first_question ? session.first_question.substring(0, 50) + '...' : 'New Chat';
                const lastMessageTime = session.last_message_timestamp ? new Date(session.last_message_timestamp).toLocaleString() : 'N/A';

                sessionItem.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${firstQuestion}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">Last: ${lastMessageTime}</div>
                    </div>
                `;
                repoChatSessionsList.appendChild(sessionItem);
            });
        }

        async function loadChatHistory(sessionId, repoId) {
            if (!currentUser) {
                alert("Please sign in to view chat history.");
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/get-chat-history?uid=${currentUser.uid}&session_id=${sessionId}`);
                const data = await response.json();

                if (response.ok) {
                    currentSessionId = sessionId;
                    currentRepoId = repoId; // Ensure repoId is set for the loaded chat
                    chatMessages.innerHTML = ''; // Clear current messages
                    data.history.forEach(qa => {
                        addMessage(qa.question, 'user');
                        addMessage(qa.answer, 'assistant');
                    });
                    chatSection.style.display = 'block'; // Show chat section
                    repoChatSessionsSection.style.display = 'none'; // Hide repo chat sessions
                    progressSection.style.display = 'none'; // Hide progress if visible
                    chatInput.focus();
                } else {
                    console.error("Error loading chat history:", data.error);
                    showError(`Failed to load chat history: ${data.error}`);
                }
            } catch (error) {
                console.error("Network error loading chat history:", error);
                showError("Network error loading chat history.");
            }
        }

        function startNewChatForRepo() {
            if (!currentRepoId) {
                alert("Please select a repository first to start a new chat.");
                return;
            }
            currentSessionId = null; // Clear session ID to start a new chat
            chatMessages.innerHTML = ''; // Clear messages
            chatInput.value = ''; // Clear input
            chatSection.style.display = 'block'; // Ensure chat section is visible
            repoChatSessionsSection.style.display = 'none'; // Hide repo chat sessions
            progressSection.style.display = 'none'; // Hide progress if visible
            chatInput.focus();
            addMessage(`Starting a new chat for repository: ${currentRepoNameSpan.textContent}.`, "assistant");
        }

        function showRepoChatSessionsSection() {
            processedReposSection.style.display = 'none';
            repoChatSessionsSection.style.display = 'block';
            chatSection.style.display = 'none';
            progressSection.style.display = 'none';
            chatMessages.innerHTML = ''; // Clear chat messages
            chatInput.value = ''; // Clear chat input
            fetchRepoChatSessions(currentRepoId); // Refresh the list of chat sessions for the current repo
        }

        async function processRepository(githubUrl) {
            if (!currentUser) {
                alert("Please sign in to process a repository.");
                return;
            }

            const isPrivate = privateRepoToggle.checked;
            let patToken = null;
            if (isPrivate) {
                patToken = patTokenInput.value.trim();
                if (!patToken) {
                    alert('Please enter a Personal Access Token for private repositories.');
                    return;
                }
            }

            try {
                processBtn.disabled = true;
                processBtn.innerHTML = '<div class="loading"></div> Processing...';
                progressSection.style.display = 'block';
                chatSection.style.display = 'none';
                processedReposSection.style.display = 'none'; // Hide repo list during processing
                repoChatSessionsSection.style.display = 'none'; // Hide repo chat sessions during processing
                
                updateProgress(0, 'Starting repository analysis...');
                addStatusLog('üöÄ Initiating repository processing...');
                
                const response = await fetch(`${API_BASE}/process-repo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        github_url: githubUrl, 
                        uid: currentUser.uid,
                        is_private: isPrivate,
                        pat_token: patToken
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleProgressUpdate(data);
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error processing repository:', error);
                addStatusLog(`‚ùå Error: ${error.message}`);
                showError(`Failed to process repository: ${error.message}`);
                // Re-fetch limits in case of an error related to limits
                if (currentUser) {
                    await verifyTokenAndFetchLimits(await currentUser.getIdToken());
                }
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = 'Process Repository';
                await fetchProcessedRepos(); // Refresh processed repos after processing
                showProcessedReposSection(); // Go back to processed repos list
            }
        }
        
        function handleProgressUpdate(data) {
            if (data.progress !== undefined) {
                updateProgress(data.progress, data.status || '');
            }
            
            if (data.log) {
                addStatusLog(data.log);
            }
            
            if (data.repo_id) {
                currentRepoId = data.repo_id;
            }
            
            if (data.complete) {
                updateProgress(100, 'Repository processing complete!');
                addStatusLog('‚úÖ Processing complete! You can now ask questions about the repository.');
                setTimeout(() => {
                    // After processing, automatically load the chat for this repo
                    loadRepoChats(currentRepoId, data.owner, data.repo);
                }, 1000);
                // Update user limits after successful repo processing
                if (currentUser) {
                    currentUser.getIdToken().then(verifyTokenAndFetchLimits);
                }
            }
            
            if (data.error) {
                showError(data.error);
            }
        }
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || !currentRepoId) {
                alert("Please select a repository first or start a new chat for a repo.");
                return;
            }
            
            if (!currentUser) {
                alert("Please sign in to ask questions.");
                return;
            }

            addMessage(message, 'user');
            chatInput.value = '';
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>';
            
            try {
                const response = await fetch(`${API_BASE}/ask-question`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        repo_id: currentRepoId,
                        question: message,
                        session_id: currentSessionId, // Pass session ID
                        uid: currentUser.uid // Pass UID
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(data.answer, 'assistant');
                    if (data.session_id) {
                        currentSessionId = data.session_id; // Update session ID
                    }
                    // Update user limits after successful message
                    if (currentUser) {
                        currentUser.getIdToken().then(verifyTokenAndFetchLimits);
                    }
                    await fetchRepoChatSessions(currentRepoId); // Refresh chat sessions for the current repo
                } else {
                    addMessage(`Error: ${data.error}`, 'assistant');
                    // Re-fetch limits in case of an error related to limits
                    if (currentUser) {
                        await verifyTokenAndFetchLimits(await currentUser.getIdToken());
                    }
                }
                
            } catch (error) {
                console.error('Error asking question:', error);
                addMessage('Sorry, there was an error processing your question.', 'assistant');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send';
                chatInput.focus();
            }
        }

        // Event Listeners (moved after function definitions)
        getStartedBtn.addEventListener('click', () => {
            landingSection.style.display = 'none';
            appContent.style.display = 'block';
            // Check auth state to decide whether to show login or app content
            if (auth.currentUser) {
                showAppContent();
            } else {
                showLoginContent();
            }
        });

        googleSignInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOut);

        privateRepoToggle.addEventListener('change', () => {
            if (privateRepoToggle.checked) {
                patTokenInput.style.display = 'block';
                patTokenInput.focus();
            } else {
                patTokenInput.style.display = 'none';
                patTokenInput.value = ''; // Clear PAT when toggle is off
            }
        });

        processBtn.addEventListener('click', async () => {
            const githubUrl = githubUrlInput.value.trim();
            if (!githubUrl) {
                alert('Please enter a GitHub repository URL');
                return;
            }
            
            if (!isValidGitHubUrl(githubUrl)) {
                alert('Please enter a valid GitHub repository URL');
                return;
            }
            
            await processRepository(githubUrl);
        });
        
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        refreshReposBtn.addEventListener('click', fetchProcessedRepos);
        newChatForRepoBtn.addEventListener('click', startNewChatForRepo);
        backToReposBtn.addEventListener('click', showProcessedReposSection);
        backToChatSessionsBtn.addEventListener('click', () => {
            showRepoChatSessionsSection();
            fetchRepoChatSessions(currentRepoId); // Refresh sessions for the current repo
        });

        // Firebase Auth State Change Listener (moved after function definitions)
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in.
                currentUser = user;
                console.log("User signed in:", user.uid, user.email);
                await verifyTokenAndFetchLimits(await user.getIdToken());
                // If landing page is hidden, show app content. Otherwise, wait for "Get Started" click.
                if (landingSection.style.display === 'none') {
                    showAppContent();
                }
                await fetchProcessedRepos();
            } else {
                // User is signed out.
                currentUser = null;
                currentRepoId = null;
                currentSessionId = null;
                console.log("User signed out.");
                // If landing page is hidden, show login content. Otherwise, wait for "Get Started" click.
                if (landingSection.style.display === 'none') {
                    showLoginContent();
                }
            }
        });

        async function signInWithGoogle() {
            try {
                const result = await auth.signInWithPopup(provider);
                const idToken = await result.user.getIdToken();
                await verifyTokenAndFetchLimits(idToken);
                showAppContent();
                await fetchProcessedRepos(); // Fetch processed repos after successful sign-in
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                alert(`Failed to sign in with Google: ${error.message}`);
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                alert("You have been signed out.");
            } catch (error) {
                console.error("Sign Out Error:", error);
                alert(`Failed to sign out: ${error.message}`);
            }
        }

        // Initial state: hide app content, show landing page
        appContent.style.display = 'none';
        landingSection.style.display = 'block';
    </script>
</body>
</html>
